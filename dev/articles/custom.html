<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Custom Simulations • ffsimulator</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Custom Simulations">
<meta property="og:description" content="ffsimulator">
<meta property="og:image" content="https://ffsimulator.ffverse.com/reference/figures/logo.png">
<meta property="og:image:alt" content="ffsimulator - An R Package For Simulating Fantasy Football Seasons">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@_TanHo">
<meta name="twitter:site" content="@DynastyProcess">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ffsimulator</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">1.0.0.03</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/basic.html">Basic Simulations</a>
    </li>
    <li>
      <a href="../articles/custom.html">Custom Simulations</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://discord.com/invite/5Er2FBnnQa">
    <span class="fab fa-discord fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/ffverse/ffsimulator/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    More
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="https://www.ffverse.com">ffverse</a>
    </li>
    <li>
      <a href="https://ffscrapr.dynastyprocess.com">ffscrapr package</a>
    </li>
    <li>
      <a href="https://ffpros.ffverse.com">ffpros package</a>
    </li>
    <li>
      <a href="https://www.github.com/ffverse">ffverse GitHub</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">nflverse</li>
    <li>
      <a href="https://www.nflfastr.com">nflfastR package</a>
    </li>
    <li>
      <a href="https://github.com/nflverse">nflverse GitHub</a>
    </li>
    <li class="divider">
    <li>
      <a href="https://dynastyprocess.com">DynastyProcess.com</a>
    </li>
  </ul>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="custom_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Custom Simulations</h1>
                        <h4 class="author">Tan Ho</h4>
            
            <h4 class="date">2021-08-15</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ffverse/ffsimulator/blob/master/vignettes/custom.Rmd"><code>vignettes/custom.Rmd</code></a></small>
      <div class="hidden name"><code>custom.Rmd</code></div>

    </div>

    
    
<p>ffsimulator also provides the component subfunctions (prefixed with <code>ffs_</code>) in case you want to customize and run certain components individually. This vignette will discuss various options and paths you might use in your own analysis, and wrap up with an example of custom code for the <a href="https://scottfishbowl.com/2021/">2021 Scott Fish Bowl</a>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ffsimulator.ffverse.com">ffsimulator</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ffscrapr.ffverse.com">ffscrapr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></code></pre></div>
<div id="overview-of-ff_simulate" class="section level2">
<h2 class="hasAnchor">
<a href="#overview-of-ff_simulate" class="anchor"></a>Overview of ff_simulate()</h2>
<p>Loosely speaking, the main ff_simulate function has the following components:</p>
<ul>
<li>importing data</li>
<li>generating projections</li>
<li>calculating roster scores</li>
<li>building schedules</li>
<li>aggregating by week, season, and simulation</li>
</ul>
<p>so we’ll reuse this structure in this vignette!</p>
<div id="importing-data" class="section level3">
<h3 class="hasAnchor">
<a href="#importing-data" class="anchor"></a>Importing Data</h3>
<p>By default, ff_simulate imports the following data based on the ff_connect <code>conn</code> object that is passed in:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">scoring_history</span> <span class="op">&lt;-</span> <span class="fu">ffscrapr</span><span class="fu">::</span><span class="fu"><a href="ffscrapr.ffverse.com/reference/ff_scoringhistory.html">ff_scoringhistory</a></span><span class="op">(</span><span class="va">conn</span>, seasons <span class="op">=</span> <span class="fl">2012</span><span class="op">:</span><span class="fl">2020</span><span class="op">)</span></code></pre></div>
<p>This retrieves week-level fantasy scoring for the specified years, and is built from nflfastR weekly data combined with the platform specified league rules.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">latest_rankings</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ffs_latest_rankings.html">ffs_latest_rankings</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>This retrieves the latest FantasyPros positional rankings available from the <a href="https://github.com/dynastyprocess/data">DynastyProcess data repository</a>. If you want to customize the rankings used in your simulation, you can construct and replace this latest_rankings dataframe with one of a similar structure and column naming - the important ones are (positional) “ecr”, “sd”, “bye”, and “fantasypros_id”.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rosters</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ffs_rosters.html">ffs_rosters</a></span><span class="op">(</span><span class="va">conn</span><span class="op">)</span></code></pre></div>
<p>This retrieves rosters and attaches a fantasypros_id to them. You could run hypothetical scenarios such as trades by editing this rosters dataframe by hand and then running the simulation!</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">lineup_constraints</span> <span class="op">&lt;-</span> <span class="fu">ffscrapr</span><span class="fu">::</span><span class="fu"><a href="ffscrapr.ffverse.com/reference/ff_starter_positions.html">ff_starter_positions</a></span><span class="op">(</span><span class="va">conn</span><span class="op">)</span></code></pre></div>
<p>This retrieves lineup constraints from your fantasy platform. You can edit these to test out hypothetical starting lineup settings and minimum requirements!</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">league_info</span> <span class="op">&lt;-</span> <span class="fu">ffscrapr</span><span class="fu">::</span><span class="fu"><a href="ffscrapr.ffverse.com/reference/ff_league.html">ff_league</a></span><span class="op">(</span><span class="va">conn</span><span class="op">)</span></code></pre></div>
<p>This brings in league information that is primarily used for plot names.</p>
</div>
<div id="generating-projections" class="section level3">
<h3 class="hasAnchor">
<a href="#generating-projections" class="anchor"></a>Generating Projections</h3>
<p><code>ff_simulate</code> runs two functions to generate “projections” - the first one builds the population of weekly scores to resample from, and the second one runs the bootstrap resampling for n_seasons x n_weeks.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">adp_outcomes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ffs_adp_outcomes.html">ffs_adp_outcomes</a></span><span class="op">(</span>
    scoring_history <span class="op">=</span> <span class="va">scoring_history</span>,
    injury_model <span class="op">=</span> <span class="st">"simple"</span> <span class="co"># or "none"</span>
  <span class="op">)</span></code></pre></div>
<p>This builds out the population of weekly outcomes for each positional adp rank, using the above-mentioned scoring history as well as <code>fp_rankings_history</code> (2012-2020 historical positional rankings) and <code>fp_injury_table</code>(an injury model).</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">projected_scores</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ffs_generate_projections.html">ffs_generate_projections</a></span><span class="op">(</span>
    adp_outcomes <span class="op">=</span> <span class="va">adp_outcomes</span>,
    latest_rankings <span class="op">=</span> <span class="va">latest_rankings</span>,
    n_seasons <span class="op">=</span> <span class="fl">100</span>, <span class="co"># number of seasons</span>
    n_weeks <span class="op">=</span> <span class="fl">14</span>, <span class="co"># weeks per season</span>
    rosters <span class="op">=</span> <span class="va">rosters</span> <span class="co"># optional, reduces the sample to just rostered players</span>
  <span class="op">)</span></code></pre></div>
<p>This uses the adp_outcomes table, latest rankings, some parameters (number of seasons, number of weeks per season), and rosters, generating a dataframe of length n_seasons x n_weeks x nrow(latest_rankings) and automatically blanking out NFL bye weeks.</p>
</div>
<div id="calculating-roster-scores" class="section level3">
<h3 class="hasAnchor">
<a href="#calculating-roster-scores" class="anchor"></a>Calculating Roster Scores</h3>
<p>This is a simple process conceptually, but probably the most computationally expensive part of the simulation: first, inner join the projected_scores for each player onto the rosters, then run a linear programming optimizer to determine the optimal lineup and calculate the week’s score.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">roster_scores</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ffs_score_rosters.html">ffs_score_rosters</a></span><span class="op">(</span>
    projected_scores <span class="op">=</span> <span class="va">projected_scores</span>,
    rosters <span class="op">=</span> <span class="va">rosters</span>
  <span class="op">)</span></code></pre></div>
<p>This function performs an inner join of these two tables and calculates position rank for each player (based on the scores for each week).</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">optimal_scores</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ffs_optimise_lineups.html">ffs_optimise_lineups</a></span><span class="op">(</span>
    roster_scores <span class="op">=</span> <span class="va">roster_scores</span>,
    lineup_constraints <span class="op">=</span> <span class="va">lineup_constraints</span>,
    lineup_efficiency_mean <span class="op">=</span> <span class="fl">0.775</span>,
    lineup_efficiency_sd <span class="op">=</span> <span class="fl">0.05</span>,
    best_ball <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co"># or TRUE</span>
    parallel <span class="op">=</span> <span class="cn">FALSE</span> <span class="co"># or TRUE </span>
  <span class="op">)</span></code></pre></div>
<p>This function runs the lineup optimisation and applies a small lineup efficiency model.</p>
<p>Lineup efficiency refers to the ratio of “actual lineup score” to “optimal lineup score”. Lineup efficiency is generated as a random number that is normally distributed around 0.775 (77.5%) and has a standard deviation of 0.05. This gives the usual lineup efficiency range to be somewhere between 0.67 and 0.87, which is (in my experience) the typical range of lineup efficiency. You can adjust the lineup efficiency model for yourself, or perhaps apply your own modelling afterwards. <code>best_ball</code> forces lineup efficiency to be 100% of the optimal score.</p>
<p>There are options to use parallel processing - in my experience, 100 seasons of a 12 team league is too small to see any benefit from parallel. I’d recommend it for running larger simulations, i.e. 12 x 1000, or 100 x 1920 (like SFB)!</p>
</div>
<div id="building-schedules" class="section level3">
<h3 class="hasAnchor">
<a href="#building-schedules" class="anchor"></a>Building Schedules</h3>
<p>In order to calculate head to head wins, you need a schedule! Enter <code><a href="../reference/ffs_build_schedules.html">ffs_build_schedules()</a></code>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R">  <span class="va">schedules</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ffs_build_schedules.html">ffs_build_schedules</a></span><span class="op">(</span>
    n_teams <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">rosters</span><span class="op">$</span><span class="va">franchise_id</span><span class="op">)</span><span class="op">)</span>, 
    n_seasons <span class="op">=</span> <span class="va">n_seasons</span>,
    n_weeks <span class="op">=</span> <span class="va">n_weeks</span>,
    seed <span class="op">=</span> <span class="cn">NULL</span>
  <span class="op">)</span></code></pre></div>
<p>This efficiently builds a randomized head to head schedule for a given number of seasons, teams, and weeks.</p>
<p>It starts with the <a href="https://en.wikipedia.org/wiki/Round-robin_tournament#Scheduling_algorithm">circle method for round robin scheduling</a>, grows or shrinks the schedule to match the required number of weeks, and then shuffles both the order that teams are assigned in and the order that weeks are generated. This doesn’t “guarantee” unique schedules, but there are <code>n_teams! x n_weeks!</code> permutations of the schedule so it’s very very likely that the schedules are unique (3x10^18 possible schedules for a 12 team league playing 13 weeks).</p>
</div>
<div id="aggregating-results" class="section level3">
<h3 class="hasAnchor">
<a href="#aggregating-results" class="anchor"></a>Aggregating Results</h3>
<p>Now that we have a schedule, we can aggregate by week, and then by season, and then by simulation:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">summary_week</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ffs_summarise_week.html">ffs_summarise_week</a></span><span class="op">(</span><span class="va">optimal_scores</span>, <span class="va">schedules</span><span class="op">)</span>
<span class="va">summary_season</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ffs_summarise_week.html">ffs_summarise_season</a></span><span class="op">(</span><span class="va">summary_week</span><span class="op">)</span>
<span class="va">summary_simulation</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ffs_summarise_week.html">ffs_summarise_simulation</a></span><span class="op">(</span><span class="va">summary_season</span><span class="op">)</span></code></pre></div>
<p>Each summary function feeds into the next summary function!</p>
</div>
</div>
<div id="sfb-simulation" class="section level2">
<h2 class="hasAnchor">
<a href="#sfb-simulation" class="anchor"></a>SFB Simulation</h2>
<p>Okay! So now that we’ve done that, let’s have a look at how I’d customize these functions to simulate SFB11 - a 1,920 team contest spread over 20 league IDs. (This code typically takes about 30 minutes to run in parallel and eats up about 40GB of memory).</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>ffscrapr.cache <span class="op">=</span> <span class="st">"filesystem"</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ffsimulator.ffverse.com">ffsimulator</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ffscrapr.ffverse.com">ffscrapr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">tidyverse</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/DavisVaughan/furrr">furrr</a></span><span class="op">)</span> 
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">tictoc</span><span class="op">)</span>

<span class="fu">plan</span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">613</span><span class="op">)</span></code></pre></div>
<p>Package listing. I add furrr and set plan(multisession) so that the optimizer can be run in parallel, set ffscrapr to cache to my hard drive, and set a seed for reproducibility.</p>
<div id="import-data" class="section level3">
<h3 class="hasAnchor">
<a href="#import-data" class="anchor"></a>Import Data</h3>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">conn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mfl_connect.html">mfl_connect</a></span><span class="op">(</span><span class="fl">2021</span>, <span class="fl">47747</span><span class="op">)</span> <span class="co"># a random SFB league to grab league info from</span>

<span class="va">league_info</span> <span class="op">&lt;-</span> <span class="fu">ffscrapr</span><span class="fu">::</span><span class="fu"><a href="ffscrapr.ffverse.com/reference/ff_league.html">ff_league</a></span><span class="op">(</span><span class="va">conn</span><span class="op">)</span>

<span class="va">scoring_history</span> <span class="op">&lt;-</span> <span class="fu">ffscrapr</span><span class="fu">::</span><span class="fu"><a href="ffscrapr.ffverse.com/reference/ff_scoringhistory.html">ff_scoringhistory</a></span><span class="op">(</span><span class="va">conn</span>, <span class="fl">2012</span><span class="op">:</span><span class="fl">2020</span><span class="op">)</span>

<span class="va">adp_outcomes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ffs_adp_outcomes.html">ffs_adp_outcomes</a></span><span class="op">(</span>scoring_history <span class="op">=</span> <span class="va">scoring_history</span>, injury_model <span class="op">=</span> <span class="st">"simple"</span><span class="op">)</span>

<span class="va">latest_rankings</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ffs_latest_rankings.html">ffs_latest_rankings</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">lineup_constraints</span> <span class="op">&lt;-</span> <span class="fu">ffscrapr</span><span class="fu">::</span><span class="fu"><a href="ffscrapr.ffverse.com/reference/ff_starter_positions.html">ff_starter_positions</a></span><span class="op">(</span><span class="va">conn</span><span class="op">)</span></code></pre></div>
<p>We can use one league ID here to grab most of the historical scoring data and rules/lineups etc for the entire SFB contest (rather than running it once for each of the twenty league IDs).</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">conn2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mfl_connect.html">mfl_connect</a></span><span class="op">(</span><span class="fl">2021</span><span class="op">)</span>

<span class="va">leagues</span> <span class="op">&lt;-</span> <span class="fu"><a href="ffscrapr.ffverse.com/reference/mfl_getendpoint.html">mfl_getendpoint</a></span><span class="op">(</span><span class="va">conn2</span>, <span class="st">"leagueSearch"</span>, SEARCH <span class="op">=</span> <span class="st">"#SFB11"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">pluck</span><span class="op">(</span><span class="st">"content"</span>,<span class="st">"leagues"</span>,<span class="st">"league"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">unnest_wider</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">name</span>,<span class="st">"Mock|Copy|Satellite|Template"</span>,negate <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>


<span class="va">get_rosters</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">league_id</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="../reference/mfl_connect.html">mfl_connect</a></span><span class="op">(</span><span class="fl">2021</span>, <span class="va">league_id</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/ffs_rosters.html">ffs_rosters</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">get_franchises</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">league_id</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="../reference/mfl_connect.html">mfl_connect</a></span><span class="op">(</span><span class="fl">2021</span>, <span class="va">league_id</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="ffscrapr.ffverse.com/reference/ff_franchises.html">ff_franchises</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">rosters_raw</span> <span class="op">&lt;-</span> <span class="va">leagues</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">homeURL</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    rosters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/furrr/man/future_map.html">future_map</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">get_rosters</span><span class="op">)</span>,
    franchises <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/furrr/man/future_map.html">future_map</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">get_franchises</span><span class="op">)</span>
  <span class="op">)</span>

<span class="va">franchises</span> <span class="op">&lt;-</span> <span class="va">rosters_raw</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>league_id <span class="op">=</span> <span class="va">id</span>, <span class="va">franchises</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">unnest</span><span class="op">(</span><span class="va">franchises</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">league_id</span>, <span class="va">franchise_id</span>, <span class="va">division_name</span><span class="op">)</span>

<span class="va">rosters</span> <span class="op">&lt;-</span> <span class="va">rosters_raw</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">rosters</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">unnest</span><span class="op">(</span><span class="va">rosters</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">franchises</span>,by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"league_id"</span>,<span class="st">"franchise_id"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Because SFB is spread over multiple league IDs, we need to get a list of IDs from the leagueSearch endpoint, map over them with the get_rosters and get_franchises helper functions we just defined, and attach the division name.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">n_seasons</span> <span class="op">&lt;-</span> <span class="fl">100</span>
<span class="va">n_weeks</span> <span class="op">&lt;-</span> <span class="fl">13</span>
<span class="va">projected_scores</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ffs_generate_projections.html">ffs_generate_projections</a></span><span class="op">(</span>adp_outcomes <span class="op">=</span> <span class="va">adp_outcomes</span>,
                                             latest_rankings <span class="op">=</span> <span class="va">latest_rankings</span>,
                                             n_seasons <span class="op">=</span> <span class="va">n_seasons</span>,
                                             n_weeks <span class="op">=</span> <span class="va">n_weeks</span>,
                                             rosters <span class="op">=</span> <span class="va">rosters</span><span class="op">)</span>

<span class="fu">tictoc</span><span class="fu">::</span><span class="fu">tic</span><span class="op">(</span><span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"ffs_score_rosters {Sys.time()}"</span><span class="op">)</span><span class="op">)</span>
<span class="va">roster_scores</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ffs_score_rosters.html">ffs_score_rosters</a></span><span class="op">(</span><span class="va">projected_scores</span>, <span class="va">rosters</span><span class="op">)</span>
<span class="fu">tictoc</span><span class="fu">::</span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span>

<span class="fu">tictoc</span><span class="fu">::</span><span class="fu">tic</span><span class="op">(</span><span class="st">"ffs_optimize_lineups {Sys.time()}"</span><span class="op">)</span>
<span class="va">optimal_scores</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ffs_optimise_lineups.html">ffs_optimize_lineups</a></span><span class="op">(</span>
  roster_scores <span class="op">=</span> <span class="va">roster_scores</span>,
  lineup_constraints <span class="op">=</span> <span class="va">lineup_constraints</span>,
  best_ball <span class="op">=</span> <span class="cn">FALSE</span>,
  parallel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu">tictoc</span><span class="fu">::</span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>These are pretty straight forward, I use tictoc here to time the most expensive parts of the computation so that I know how long it takes - on my machine, this takes between 20-25 minutes to compute.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">schedules</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ffs_build_schedules.html">ffs_build_schedules</a></span><span class="op">(</span>n_teams <span class="op">=</span> 
                                   <span class="va">rosters</span> <span class="op">%&gt;%</span>
                                    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span>
                                      <span class="va">.data</span><span class="op">$</span><span class="va">league_id</span>,
                                      <span class="va">.data</span><span class="op">$</span><span class="va">franchise_id</span><span class="op">)</span> <span class="op">%&gt;%</span>
                                    <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span>,
                                 n_seasons <span class="op">=</span> <span class="va">n_seasons</span>,
                                 n_weeks <span class="op">=</span> <span class="va">n_weeks</span><span class="op">)</span>

<span class="va">summary_week</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ffs_summarise_week.html">ffs_summarise_week</a></span><span class="op">(</span><span class="va">optimal_scores</span>, <span class="va">schedules</span><span class="op">)</span>
<span class="va">summary_season</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ffs_summarise_week.html">ffs_summarise_season</a></span><span class="op">(</span><span class="va">summary_week</span><span class="op">)</span>
<span class="va">summary_simulation</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ffs_summarise_week.html">ffs_summarise_simulation</a></span><span class="op">(</span><span class="va">summary_season</span><span class="op">)</span></code></pre></div>
<p>By comparison, these are very fast to compute (a minute or two total).</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://twitter.com/_TanHo">Tan Ho</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
